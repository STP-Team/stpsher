"""–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ–±—É—á–µ–Ω–∏—è—Ö.

–ú–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ–±—É—á–µ–Ω–∏–π.
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∑–∞ 2 —á–∞—Å–∞ –∏ –∑–∞ 1 —á–∞—Å –¥–æ –Ω–∞—á–∞–ª–∞ –æ–±—É—á–µ–Ω–∏—è.

–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
    - –ü–∞—Ä—Å–∏–Ω–≥ Excel-—Ñ–∞–π–ª–∞ —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –æ–±—É—á–µ–Ω–∏–π
    - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–∏–±–ª–∏–∂–∞—é—â–∏—Ö—Å—è –æ–±—É—á–µ–Ω–∏–π
    - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
    - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ç–ø—Ä–∞–≤–∫–∏

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
    - StudiesScheduler: –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
    - check_upcoming_studies: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–±–ª–∏–∂–∞—é—â–∏—Ö—Å—è –æ–±—É—á–µ–Ω–∏–π
    - send_study_notifications: –†–∞—Å—Å—ã–ª–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
    - create_study_notification_message: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
"""

import logging
from datetime import datetime, timedelta
from pathlib import Path
from typing import List, Set

from aiogram import Bot
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from stp_database import MainRequestsRepo

from tgbot.services.broadcaster import send_message
from tgbot.services.files_processing.parsers.studies import (
    StudiesScheduleParser,
    StudySession,
)
from tgbot.services.schedulers.base import BaseScheduler

logger = logging.getLogger(__name__)


class StudiesScheduler(BaseScheduler):
    """–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ–±—É—á–µ–Ω–∏—è—Ö.

    –£–ø—Ä–∞–≤–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –æ–±—É—á–µ–Ω–∏–π
    –∑–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –¥–æ –Ω–∞—á–∞–ª–∞ —Å–µ—Å—Å–∏–∏. –ù–∞—Å–ª–µ–¥—É–µ—Ç –±–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
    –æ—Ç BaseScheduler –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫—É—é –ª–æ–≥–∏–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—É—á–µ–Ω–∏—è–º–∏.

    –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
        - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–±–ª–∏–∂–∞—é—â–∏—Ö—Å—è –æ–±—É—á–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
        - –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞ 2 —á–∞—Å–∞ –∏ –∑–∞ 1 —á–∞—Å –¥–æ –Ω–∞—á–∞–ª–∞ –æ–±—É—á–µ–Ω–∏—è
        - –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –æ–± –æ–±—É—á–µ–Ω–∏—è—Ö –∏–∑ Excel-—Ñ–∞–π–ª–∞
        - –ü–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º

    Attributes:
        studies_parser: –≠–∫–∑–µ–º–ø–ª—è—Ä StudiesScheduleParser –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞ –æ–±—É—á–µ–Ω–∏–π

    Note:
        –ö–ª–∞—Å—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
        –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ, –ø—Ä–æ–≤–µ—Ä—è—è –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ uploads/–û–±—É—á–µ–Ω–∏—è.xlsx
    """

    def __init__(self):
        super().__init__("–û–±—É—á–µ–Ω–∏—è")
        self.studies_parser = StudiesScheduleParser()

    def setup_jobs(self, scheduler: AsyncIOScheduler, session_pool, bot: Bot):
        """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∑–∞–¥–∞—á–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ–±—É—á–µ–Ω–∏—è—Ö.

        –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ –∑–∞–¥–∞—á—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
        –ø—Ä–∏–±–ª–∏–∂–∞—é—â–∏—Ö—Å—è –æ–±—É—á–µ–Ω–∏–π. –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
        –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

        Args:
            scheduler: –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á APScheduler –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞–Ω–∏–π
            session_pool: –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
            bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

        Note:
            –ú–µ—Ç–æ–¥ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±–∞–∑–æ–≤—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é BaseScheduler
            –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é –¥–ª—è –æ–±—É—á–µ–Ω–∏–π –ª–æ–≥–∏–∫—É –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
        """
        self.logger.info("–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–¥–∞—á —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ–±—É—á–µ–Ω–∏—è—Ö...")

        scheduler.add_job(
            func=self._check_upcoming_studies_job,
            args=[session_pool, bot],
            trigger="interval",
            id=f"{self.category_name}_check_upcoming_studies",
            name="–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –æ–±—É—á–µ–Ω–∏–π",
            minutes=30,
        )

    async def _check_upcoming_studies_job(self, session_pool, bot: Bot):
        """–û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏–±–ª–∏–∂–∞—é—â–∏—Ö—Å—è –æ–±—É—á–µ–Ω–∏–π.

        –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏–±–ª–∏–∂–∞—é—â–∏—Ö—Å—è –æ–±—É—á–µ–Ω–∏–π —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –Ω–∞—á–∞–ª–∞
        –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏.

        Args:
            session_pool: –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
            bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

        Returns:
            dict: –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ

        Note:
            –ú–µ—Ç–æ–¥ —è–≤–ª—è–µ—Ç—Å—è –æ–±–µ—Ä—Ç–∫–æ–π –≤–æ–∫—Ä—É–≥ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ check_upcoming_studies
            –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º BaseScheduler.
        """
        self._log_job_execution_start("–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –æ–±—É—á–µ–Ω–∏–π")
        try:
            result = await check_upcoming_studies(session_pool, bot)
            self._log_job_execution_end("–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –æ–±—É—á–µ–Ω–∏–π", success=True)
            return result
        except Exception as e:
            self._log_job_execution_end(
                "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –æ–±—É—á–µ–Ω–∏–π", success=False, error=str(e)
            )


async def check_upcoming_studies(session_pool, bot: Bot):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∏–±–ª–∏–∂–∞—é—â–∏–µ—Å—è –æ–±—É—á–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º.

    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±—É—á–µ–Ω–∏–π –∏–∑ Excel-—Ñ–∞–π–ª–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
    —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –∑–∞ 2 —á–∞—Å–∞ –∏ –∑–∞ 1 —á–∞—Å –¥–æ –Ω–∞—á–∞–ª–∞ –æ–±—É—á–µ–Ω–∏—è.
    –†–∞–±–æ—Ç–∞–µ—Ç —Å –æ–∫–Ω–æ–º –≤ 10 –º–∏–Ω—É—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.

    Args:
        session_pool: –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ Telegram –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

    Returns:
        dict: –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
            - status: "success" –∏–ª–∏ "error"
            - message: –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ (–ø—Ä–∏ –æ—à–∏–±–∫–µ)
            - sessions: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö –æ–±—É—á–µ–Ω–∏–π (–ø—Ä–∏ —É—Å–ø–µ—Ö–µ)
            - notifications: –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            - results: –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Å–µ—Å—Å–∏—è–º

    Raises:
        Exception: –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ñ–∞–π–ª–∞ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

    Note:
        - –û–∂–∏–¥–∞–µ—Ç —Ñ–∞–π–ª –ø–æ –ø—É—Ç–∏ uploads/–û–±—É—á–µ–Ω–∏—è.xlsx
        - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –æ–∫–Ω–µ ¬±10 –º–∏–Ω—É—Ç –æ—Ç —Ü–µ–ª–µ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        - –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã
    """
    try:
        studies_parser = StudiesScheduleParser()
        file_path = Path("uploads/–û–±—É—á–µ–Ω–∏—è.xlsx")

        if not file_path.exists():
            logger.warning("[–û–±—É—á–µ–Ω–∏—è] –§–∞–π–ª –æ–±—É—á–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω: –û–±—É—á–µ–Ω–∏—è.xlsx")
            return {"status": "error", "message": "–§–∞–π–ª –æ–±—É—á–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω"}

        all_sessions = studies_parser.parse_studies_file(file_path)

        if not all_sessions:
            logger.info("[–û–±—É—á–µ–Ω–∏—è] No study sessions found in file")
            return {"status": "success", "message": "No study sessions found"}

        now = datetime.now()

        upcoming_sessions = []
        for session in all_sessions:
            time_diff = session.date - now

            two_hours_before = timedelta(hours=2)
            if abs(time_diff - two_hours_before) <= timedelta(minutes=10):
                upcoming_sessions.append(session)
                continue

            one_hour_before = timedelta(hours=1)
            if abs(time_diff - one_hour_before) <= timedelta(minutes=10):
                upcoming_sessions.append(session)

        if not upcoming_sessions:
            logger.debug(
                "[–û–±—É—á–µ–Ω–∏—è] –ù–µ—Ç –æ–±—É—á–µ–Ω–∏–π, —Ç—Ä–µ–±—É–µ–º—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∑–∞ 2 —á–∞—Å–∞ –∏–ª–∏ 1 —á–∞—Å)"
            )
            return {"status": "success", "message": "No studies requiring notification"}

        logger.info(
            f"[–û–±—É—á–µ–Ω–∏—è] –ù–∞–π–¥–µ–Ω–æ {len(upcoming_sessions)} –ø—Ä–∏–±–ª–∏–∂–∞—é—â–∏—Ö—Å—è –æ–±—É—á–µ–Ω–∏–π"
        )

        notification_results = await send_study_notifications(
            upcoming_sessions, session_pool, bot
        )

        total_notifications = sum(notification_results.values())
        logger.info(
            f"[–û–±—É—á–µ–Ω–∏—è] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {total_notifications} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è {len(upcoming_sessions)} –æ–±—É—á–µ–Ω–∏–π"
        )

        return {
            "status": "success",
            "sessions": len(upcoming_sessions),
            "notifications": total_notifications,
            "results": notification_results,
        }

    except Exception as e:
        logger.error(f"[–û–±—É—á–µ–Ω–∏—è] Critical error checking upcoming studies: {e}")
        return {"status": "error", "message": str(e)}


async def send_study_notifications(
    sessions: List[StudySession], session_pool, bot: Bot
) -> dict:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –æ–±—É—á–µ–Ω–∏–π.

    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π –æ–±—É—á–µ–Ω–∏–π –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ
    —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º, –Ω–∞–π–¥–µ–Ω–Ω—ã–º –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
    –ò–∑–±–µ–≥–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º (–Ω–µ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è–º).

    Args:
        sessions: –°–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π –æ–±—É—á–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        session_pool: –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ Telegram –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

    Returns:
        dict: –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ –∫–∞–∂–¥–æ–π —Å–µ—Å—Å–∏–∏,
            –≥–¥–µ –∫–ª—é—á - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–∏ (–¥–∞—Ç–∞_–Ω–∞–∑–≤–∞–Ω–∏–µ),
            –∑–Ω–∞—á–µ–Ω–∏–µ - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

    Note:
        - –ò–∑–≤–ª–µ–∫–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ç–æ–ª—å–∫–æ –∏–∑ –ø–æ–ª—è –§–ò–û (–∏—Å–∫–ª—é—á–∞—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–π –∏–∑ –†–ì)
        - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç set –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        - –õ–æ–≥–∏—Ä—É–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
        - –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–µ–∑ user_id –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    """
    notification_results = {}

    async with session_pool() as session:
        stp_repo = MainRequestsRepo(session)

        for session_obj in sessions:
            session_key = f"{session_obj.date.strftime('%d.%m.%Y')}_{session_obj.title}"
            notifications_sent = 0

            participant_names: Set[str] = set()
            for area, name, rg, attendance, reason in session_obj.participants:
                if name and name.strip():
                    participant_names.add(name.strip())

            logger.debug(
                f"[–û–±—É—á–µ–Ω–∏—è] –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—É—á–µ–Ω–∏–µ: {session_obj.title} –Ω–∞ {session_obj.date.strftime('%d.%m.%Y')}"
            )
            logger.debug(
                f"[–û–±—É—á–µ–Ω–∏—è] –ù–∞–π–¥–µ–Ω–æ {len(participant_names)} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {list(participant_names)}"
            )

            for participant_name in participant_names:
                try:
                    participant = await stp_repo.employee.get_users(
                        fullname=participant_name
                    )

                    if not participant:
                        logger.warning(
                            f"[–û–±—É—á–µ–Ω–∏—è] –£—á–∞—Å—Ç–Ω–∏–∫ '{participant_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î"
                        )
                        continue

                    if not participant.user_id:
                        logger.warning(
                            f"[–û–±—É—á–µ–Ω–∏—è] –£—á–∞—Å—Ç–Ω–∏–∫ '{participant_name}' –Ω–∞–π–¥–µ–Ω –≤ –ë–î, –Ω–æ –Ω–µ –∏–º–µ–µ—Ç user_id"
                        )
                        continue

                    time_diff = session_obj.date - datetime.now()

                    message = await create_study_notification_message(
                        session_obj, stp_repo, time_diff
                    )

                    success = await send_message(bot, participant.user_id, message)

                    if success:
                        notifications_sent += 1
                        logger.debug(
                            f"[–û–±—É—á–µ–Ω–∏—è] {participant_name} —É–≤–µ–¥–æ–º–ª–µ–Ω –æ —Å–∫–æ—Ä–æ–º –æ–±—É—á–µ–Ω–∏–∏"
                        )
                    else:
                        logger.warning(
                            f"[–û–±—É—á–µ–Ω–∏—è] –û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è {participant_name}"
                        )

                except Exception as e:
                    logger.error(
                        f"[–û–±—É—á–µ–Ω–∏—è] Error notifying participant {participant_name}: {e}"
                    )
                    continue

            notification_results[session_key] = notifications_sent
            logger.info(
                f"[–û–±—É—á–µ–Ω–∏—è] –û–±—É—á–µ–Ω–∏–µ {session_key}: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {notifications_sent} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
            )

    return notification_results


async def create_study_notification_message(
    session: StudySession, stp_repo, time_diff: timedelta
) -> str:
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ–±—É—á–µ–Ω–∏–∏ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–∞.

    –°–æ–∑–¥–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ–±—É—á–µ–Ω–∏–∏,
    –≤–∫–ª—é—á–∞—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ç–µ–∫—Å—Ç –≤—Ä–µ–º–µ–Ω–∏, —Å—Å—ã–ª–∫—É –Ω–∞ —Ç—Ä–µ–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
    –∏ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ—Å–µ—â–µ–Ω–∏—è –æ–±—É—á–µ–Ω–∏–π.

    Args:
        session: –û–±—ä–µ–∫—Ç —Å–µ—Å—Å–∏–∏ –æ–±—É—á–µ–Ω–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –¥–∞—Ç–µ, —Ç–µ–º–µ, —Ç—Ä–µ–Ω–µ—Ä–µ
        stp_repo: –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
        time_diff: –†–∞–∑–Ω–∏—Ü–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ –Ω–∞—á–∞–ª–∞ –æ–±—É—á–µ–Ω–∏—è

    Returns:
        str: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ HTML-—Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram

    Note:
        - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (2 —á–∞—Å–∞/1 —á–∞—Å/–¥—Ä—É–≥–æ–µ)
        - –ü—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å —Ç—Ä–µ–Ω–µ—Ä–∞ –≤ Telegram
        - –í–∫–ª—é—á–∞–µ—Ç –±–ª–æ–∫ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è –æ–±—É—á–µ–Ω–∏–π
        - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç HTML-—Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

    Examples:
        –î–ª—è –æ–±—É—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞:
        "–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞ —É —Ç–µ–±—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –æ–±—É—á–µ–Ω–∏–µ..."

        –î–ª—è –æ–±—É—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ 1 —á–∞—Å:
        "–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ —á–µ—Ä–µ–∑ 1 —á–∞—Å —É —Ç–µ–±—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –æ–±—É—á–µ–Ω–∏–µ..."
    """
    if abs(time_diff - timedelta(hours=2)) <= timedelta(minutes=10):
        time_text = "—á–µ—Ä–µ–∑ 2 —á–∞—Å–∞"
    elif abs(time_diff - timedelta(hours=1)) <= timedelta(minutes=10):
        time_text = "—á–µ—Ä–µ–∑ 1 —á–∞—Å"
    else:
        days_until = (session.date.date() - datetime.now().date()).days
        if days_until == 0:
            time_text = "—Å–µ–≥–æ–¥–Ω—è"
        elif days_until == 1:
            time_text = "–∑–∞–≤—Ç—Ä–∞"
        else:
            time_text = f"—á–µ—Ä–µ–∑ {days_until} –¥–Ω."

    trainer_text = session.trainer
    if session.trainer:
        try:
            trainer_user = await stp_repo.employee.get_users(fullname=session.trainer)
            if trainer_user and trainer_user.username:
                trainer_text = (
                    f"<a href='t.me/{trainer_user.username}'>{session.trainer}</a>"
                )
        except Exception as e:
            logger.warning(
                f"[–û–±—É—á–µ–Ω–∏—è] Could not get trainer info for {session.trainer}: {e}"
            )

    message_parts = [
        "üìö <b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± –æ–±—É—á–µ–Ω–∏–∏</b>\n",
        f"–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ <b>{time_text}</b> —É —Ç–µ–±—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –æ–±—É—á–µ–Ω–∏–µ:\n",
        f"üìñ <b>–¢–µ–º–∞:</b> {session.title}",
        f"üéì <b>–¢—Ä–µ–Ω–µ—Ä:</b> {trainer_text}",
        f"\nüìÖ <b>–î–∞—Ç–∞:</b> {session.date.strftime('%d.%m.%Y')} {session.time} {f'({session.duration})' if session.duration else ''}",
    ]

    message_parts.extend([
        "\n<blockquote expandable>üí° <b>–ü—Ä–∞–≤–∏–ª–∞ –ø–æ—Å–µ—â–µ–Ω–∏—è –æ–±—É—á–µ–Ω–∏–π</b>",
        "‚Ä¢ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏ —è–≤–∫—É –≤ –ø–∏—Å—å–º–µ –æ–± –æ–±—É—á–µ–Ω–∏–∏ –Ω–∞ –ø–æ—á—Ç–µ",
        "‚Ä¢ –ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –Ω–µ—è–≤–∫–µ - –∑–∞ 2 —á–∞—Å–∞ –¥–æ –Ω–∞—á–∞–ª–∞ –æ–±—É—á–µ–Ω–∏—è —Å –ª–∏–Ω–∏–∏",
        "‚Ä¢ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–ª–∏—á–∏–µ –∫–∞–º–µ—Ä—ã</blockquote>",
    ])

    return "\n".join(message_parts)


def format_studies_notification_summary(sessions: List[StudySession]) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –æ–±—É—á–µ–Ω–∏–π –¥–ª—è –ª–æ–≥–æ–≤.

    –°–æ–∑–¥–∞–µ—Ç –∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ–±—É—á–µ–Ω–∏–π, –≥—Ä—É–ø–ø–∏—Ä—É—è –∏—Ö –ø–æ –¥–∞—Ç–∞–º
    –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤ –ª–æ–≥–∞—Ö —Å–∏—Å—Ç–µ–º—ã. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    –∏ –æ—Ç–ª–∞–¥–∫–∏ —Ä–∞–±–æ—Ç—ã –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

    Args:
        sessions: –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö —Å–µ—Å—Å–∏–π –æ–±—É—á–µ–Ω–∏–π

    Returns:
        str: –ö—Ä–∞—Ç–∫–∞—è —Å—Ç—Ä–æ–∫–∞-—Å–≤–æ–¥–∫–∞ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ–±—É—á–µ–Ω–∏–π –ø–æ –¥–∞—Ç–∞–º

    Examples:
        –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫:
        "No upcoming studies found"

        –ù–µ—Å–∫–æ–ª—å–∫–æ –æ–±—É—á–µ–Ω–∏–π:
        "Upcoming studies: 3, ‚Ä¢ 15.11.2025: 2 session(s), ‚Ä¢ 16.11.2025: 1 session(s)"

    Note:
        –§—É–Ω–∫—Ü–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –∞ —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±–∑–æ—Ä–∞ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –æ–±—É—á–µ–Ω–∏–π.
    """
    if not sessions:
        return "No upcoming studies found"

    summary_parts = [f"Upcoming studies: {len(sessions)}"]

    dates = {}
    for session in sessions:
        date_str = session.date.strftime("%d.%m.%Y")
        if date_str not in dates:
            dates[date_str] = 0
        dates[date_str] += 1

    for date_str, count in dates.items():
        summary_parts.append(f"‚Ä¢ {date_str}: {count} session(s)")

    return ", ".join(summary_parts)
